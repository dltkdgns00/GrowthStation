<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="res/hive.service.base.js"></script>
  <title>GrowthStation</title>
</head>

<body>
  <h1>식물 생육 모니터링</h1>
  <!-- <pre id="status">Waiting for updates...</pre> JSON 데이터를 표시 -->
  <h2>최신 사진</h2>
  <div style="display: flex;">
    <div>
      <img id="lastImage" src="" alt="No image captured yet" width="500">
    </div>
    <div>
      <table>
        <tr>
          <td>온도</td>
          <td id="temp"></td>
        </tr>
        <tr>
          <td>습도</td>
          <td id="hum"></td>
        </tr>
      </table>
      <table>
        <tr>
          <td id="LED"></td>
          <td id="LED_status"></td>
        </tr>
        <tr>
          <td id="FAN"></td>
          <td id="FAN_status"></td>
        </tr>
        <tr>
          <td id="PUMP"></td>
          <td id="PUMP_status"></td>
        </tr>
      </table>
    </div>
  </div>

  <h2>Control Panel</h2>
  <form id="controlPanel">
    <div>
      LED 제어
      <label for="led_start_time">시작</label>
      <input type="number" id="led_start_time" name="led_start_time" min="0" max="23" required>
      <label for="led_end_time">종료</label>
      <input type="number" id="led_end_time" name="led_end_time" min="0" max="23" required>
      <label for="led_interval">Interval (seconds):</label> <!-- on off 추가 -->
      <input type="number" id="led_interval" name="led_interval" min="1" required>
    </div>

    <div>
      FAN 제어
      <label for="fan_start_time">시작</label>
      <input type="number" id="fan_start_time" name="fan_start_time" min="0" max="23" required>
      <label for="fan_end_time">종료</label>
      <input type="number" id="fan_end_time" name="fan_end_time" min="0" max="23" required>
      <label for="fan_interval">Interval (seconds):</label>
      <input type="number" id="fan_interval" name="fan_interval" min="1" required>
    </div>

    <div>
      PUMP 제어
      <label for="pump_start_time">시작</label>
      <input type="number" id="pump_start_time" name="pump_start_time" min="0" max="23" required>
      <label for="pump_end_time">종료</label>
      <input type="number" id="pump_end_time" name="pump_end_time" min="0" max="23" required>
      <label for="pump_interval">Interval (seconds):</label>
      <input type="number" id="pump_interval" name="pump_interval" min="1" required>
    </div>

    <div>
      <button type="submit">Submit</button>
    </div>
  </form>

  <h2>Timelapse Videos</h2> <!-- 영상은 팝업을 띄운다 -->

  <div style="display: flex;">
    <div id="timelapse_videos"></div>
    <div style="margin-left: 20px; flex: 1; position: relative; padding-top: 75%;">
      <iframe id="videoFrame" src="" frameborder="0"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"></iframe>
    </div>
  </div>

  <script>
    const API_post = "/www";

    let socket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/wss/");

    socket.onmessage = function (event)
    {
      // 웹소켓으로 받은 데이터를 JSON으로 파싱
      let message = JSON.parse(event.data);
      // console.log("Message from server:", message);

      // 상태를 status div에 표시
      // _("status").innerText = JSON.stringify(message.data, null, 2);

      // 가장 최근에 찍은 사진의 경로가 있으면 img 태그에 추가
      if (message.data.Camera)
      {
        // console.log("Updating last image:", message.data.Camera.latest_image);
        _("lastImage").src = message.data.Camera.latest_image;

        _("temp").innerText = message.data.Camera.temperature;
        _("hum").innerText = message.data.Camera.humidity;

      }

      if (message.data.LED)
      {
        // console.log("Updating LED status:", message.data.LED);
        _("LED").innerText = "LED";
        if (message.data.LED.state)
        {
          _("LED_status").innerText = "ON";
        }
        else
        {
          _("LED_status").innerText = "OFF";
        }
      }
      if (message.data.FAN)
      {
        // console.log("Updating FAN status:", message.data.FAN);
        _("FAN").innerText = "FAN";
        if (message.data.FAN.state)
        {
          _("FAN_status").innerText = "ON";
        }
        else
        {
          _("FAN_status").innerText = "OFF";
        }
      }
      if (message.data.PUMP)
      {
        // console.log("Updating PUMP status:", message.data.PUMP);
        _("PUMP").innerText = "PUMP";
        if (message.data.PUMP.state)
        {
          _("PUMP_status").innerText = "ON";
        }
        else
        {
          _("PUMP_status").innerText = "OFF";
        }
      }
    };

    socket.onopen = function (event)
    {
      console.log("WebSocket connection established");
    };

    socket.onclose = function (event)
    {
      console.log("WebSocket connection closed");
    };

    _("controlPanel").addEventListener("submit", function (event)
    {
      event.preventDefault(); // 폼의 기본 제출 동작을 막음

      // 폼 데이터를 수집
      var led_start_time = _('led_start_time').value;
      var led_end_time = _('led_end_time').value;
      var led_interval = _('led_interval').value;

      var fan_start_time = _('fan_start_time').value;
      var fan_end_time = _('fan_end_time').value;
      var fan_interval = _('fan_interval').value;

      var pump_start_time = _('pump_start_time').value;
      var pump_end_time = _('pump_end_time').value;
      var pump_interval = _('pump_interval').value;

      var data = new FormData();

      var env = {
        LED: {
          start_time: led_start_time,
          end_time: led_end_time,
          interval: led_interval
        },
        FAN: {
          start_time: fan_start_time,
          end_time: fan_end_time,
          interval: fan_interval
        },
        PUMP: {
          start_time: pump_start_time,
          end_time: pump_end_time,
          interval: pump_interval
        }
      };
      data.append('func', 'save_env');
      data.append('env', JSON.stringify(env));

      console.log("Sending data to server:", data);

      POST(API_post, data, function (resp)
      {
        if (resp.data)
          console.log(resp.data);
        else
          alert("no message");
      });
    });

    document.addEventListener("DOMContentLoaded", function ()
    {
      var data = new FormData();
      data.append('func', 'get_timelapse_videos');

      POST(API_post, data, function (resp)
      {
        if (resp.data)
        {
          const container = document.getElementById("timelapse_videos");
          container.innerHTML = ""; // 초기화

          resp.data.forEach(video =>
          {
            const videoLink = document.createElement("a");
            videoLink.href = "#";
            videoLink.innerText = video.name;
            videoLink.onclick = () =>
            {
              const iframe = document.getElementById("videoFrame");
              iframe.src = video.path;
            };
            videoLink.style.display = "block";
            container.appendChild(videoLink);
          });

        }
        else
          alert("no message");
      });
    });


  </script>
</body>

</html>