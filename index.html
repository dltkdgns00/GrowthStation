<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="res/hive.service.base.js"></script>
  <title>GrowthStation</title>
</head>

<body>
  <h1>식물 생육 모니터링</h1>
  <!-- <pre id="status">Waiting for updates...</pre> JSON 데이터를 표시 -->
  <h2>최신 사진</h2>
  <div style="display: flex;">
    <div>
      <img id="lastImage" src="" alt="No image captured yet" width="500">
    </div>
    <div>
      <table>
        <tr>
          <td>온도</td>
          <td id="temp"></td>
        </tr>
        <tr>
          <td>습도</td>
          <td id="hum"></td>
        </tr>
      </table>
      <table>
        <tr>
          <td id="LED"></td>
          <td id="LED_status"></td>
        </tr>
        <tr>
          <td id="FAN"></td>
          <td id="FAN_status"></td>
        </tr>
        <tr>
          <td id="PUMP"></td>
          <td id="PUMP_status"></td>
        </tr>
      </table>
    </div>
  </div>

  <h2>Control Panel</h2>
  <form id="controlPanel">
    <div>
      LED 제어
      <label for="led_start_hour">시작 시간 (시)</label>
      <input type="number" id="led_start_hour" name="led_start_hour" min="0" max="23" required>
      <label for="led_start_minute">시작 시간 (분)</label>
      <input type="number" id="led_start_minute" name="led_start_minute" min="0" max="59" required>

      <label for="led_end_hour">종료 시간 (시)</label>
      <input type="number" id="led_end_hour" name="led_end_hour" min="0" max="23" required>
      <label for="led_end_minute">종료 시간 (분)</label>
      <input type="number" id="led_end_minute" name="led_end_minute" min="0" max="59" required>

      <label for="led_on_time">켜짐 시간 (seconds)</label> <!-- on_time 추가 -->
      <input type="number" id="led_on_time" name="led_on_time" min="1" required>
      <label for="led_off_time">꺼짐 시간 (seconds)</label> <!-- off_time 추가 -->
      <input type="number" id="led_off_time" name="led_off_time" min="1" required>
    </div>

    <div>
      FAN 제어
      <label for="fan_start_hour">시작 시간 (시)</label>
      <input type="number" id="fan_start_hour" name="fan_start_hour" min="0" max="23" required>
      <label for="fan_start_minute">시작 시간 (분)</label>
      <input type="number" id="fan_start_minute" name="fan_start_minute" min="0" max="59" required>

      <label for="fan_end_hour">종료 시간 (시)</label>
      <input type="number" id="fan_end_hour" name="fan_end_hour" min="0" max="23" required>
      <label for="fan_end_minute">종료 시간 (분)</label>
      <input type="number" id="fan_end_minute" name="fan_end_minute" min="0" max="59" required>

      <label for="fan_on_time">켜짐 시간 (seconds)</label> <!-- on_time 추가 -->
      <input type="number" id="fan_on_time" name="fan_on_time" min="1" required>
      <label for="fan_off_time">꺼짐 시간 (seconds)</label> <!-- off_time 추가 -->
      <input type="number" id="fan_off_time" name="fan_off_time" min="1" required>
    </div>

    <div>
      PUMP 제어
      <label for="pump_start_hour">시작 시간 (시)</label>
      <input type="number" id="pump_start_hour" name="pump_start_hour" min="0" max="23" required>
      <label for="pump_start_minute">시작 시간 (분)</label>
      <input type="number" id="pump_start_minute" name="pump_start_minute" min="0" max="59" required>

      <label for="pump_end_hour">종료 시간 (시)</label>
      <input type="number" id="pump_end_hour" name="pump_end_hour" min="0" max="23" required>
      <label for="pump_end_minute">종료 시간 (분)</label>
      <input type="number" id="pump_end_minute" name="pump_end_minute" min="0" max="59" required>

      <label for="pump_on_time">켜짐 시간 (seconds)</label> <!-- on_time 추가 -->
      <input type="number" id="pump_on_time" name="pump_on_time" min="1" required>
      <label for="pump_off_time">꺼짐 시간 (seconds)</label> <!-- off_time 추가 -->
      <input type="number" id="pump_off_time" name="pump_off_time" min="1" required>
    </div>

    <div>
      카메라 설정
      <label for="camera_interval">사진 촬영 간격 (seconds)</label> <!-- 카메라 인터벌 추가 -->
      <input type="number" id="camera_interval" name="camera_interval" min="1" required>
    </div>

    <div>
      <button type="submit">Submit</button>
    </div>
  </form>

  <h2>Timelapse Videos</h2> <!-- 영상은 팝업을 띄운다 -->

  <div style="display: flex;">
    <div id="timelapse_videos"></div>
    <div style="margin-left: 20px; flex: 1; position: relative; padding-top: 75%;">
      <iframe id="videoFrame" src="" frameborder="0"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"></iframe>
    </div>
  </div>

  <script>
    const API_post = "/www";

    let socket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/wss/");

    document.addEventListener("DOMContentLoaded", function ()
    {
      get_timelapse_videos();
      get_env_data();
    });

    socket.onmessage = function (event)
    {
      // 웹소켓으로 받은 데이터를 JSON으로 파싱
      let message = JSON.parse(event.data);
      // console.log("Message from server:", message);

      // 상태를 status div에 표시
      // _("status").innerText = JSON.stringify(message.data, null, 2);

      // 가장 최근에 찍은 사진의 경로가 있으면 img 태그에 추가
      if (message.data.Camera)
      {
        // console.log("Updating last image:", message.data.Camera.latest_image);
        _("lastImage").src = message.data.Camera.latest_image;

        _("temp").innerText = message.data.Camera.temperature;
        _("hum").innerText = message.data.Camera.humidity;

      }

      if (message.data.LED)
      {
        // console.log("Updating LED status:", message.data.LED);
        _("LED").innerText = "LED";
        if (message.data.LED.state)
        {
          _("LED_status").innerText = "ON";
        }
        else
        {
          _("LED_status").innerText = "OFF";
        }
      }
      if (message.data.FAN)
      {
        // console.log("Updating FAN status:", message.data.FAN);
        _("FAN").innerText = "FAN";
        if (message.data.FAN.state)
        {
          _("FAN_status").innerText = "ON";
        }
        else
        {
          _("FAN_status").innerText = "OFF";
        }
      }
      if (message.data.PUMP)
      {
        // console.log("Updating PUMP status:", message.data.PUMP);
        _("PUMP").innerText = "PUMP";
        if (message.data.PUMP.state)
        {
          _("PUMP_status").innerText = "ON";
        }
        else
        {
          _("PUMP_status").innerText = "OFF";
        }
      }
    };

    socket.onopen = function (event)
    {
      console.log("WebSocket connection established");
    };

    socket.onclose = function (event)
    {
      console.log("WebSocket connection closed");
    };

    _("controlPanel").addEventListener("submit", function (event)
    {
      event.preventDefault(); // 폼의 기본 제출 동작을 막음

      // LED 설정 수집
      var led_start_hour = _('led_start_hour').value;
      var led_start_minute = _('led_start_minute').value;
      var led_end_hour = _('led_end_hour').value;
      var led_end_minute = _('led_end_minute').value;
      var led_on_time = _('led_on_time').value;
      var led_off_time = _('led_off_time').value;

      // FAN 설정 수집
      var fan_start_hour = _('fan_start_hour').value;
      var fan_start_minute = _('fan_start_minute').value;
      var fan_end_hour = _('fan_end_hour').value;
      var fan_end_minute = _('fan_end_minute').value;
      var fan_on_time = _('fan_on_time').value;
      var fan_off_time = _('fan_off_time').value;

      // PUMP 설정 수집
      var pump_start_hour = _('pump_start_hour').value;
      var pump_start_minute = _('pump_start_minute').value;
      var pump_end_hour = _('pump_end_hour').value;
      var pump_end_minute = _('pump_end_minute').value;
      var pump_on_time = _('pump_on_time').value;
      var pump_off_time = _('pump_off_time').value;

      // Camera 설정 수집
      var camera_interval = _('camera_interval').value;

      var data = new FormData();

      var env = {
        LED: {
          start_time: led_start_hour + ":" + led_start_minute,
          end_time: led_end_hour + ":" + led_end_minute,
          on_time: led_on_time,
          off_time: led_off_time
        },
        FAN: {
          start_time: fan_start_hour + ":" + fan_start_minute,
          end_time: fan_end_hour + ":" + fan_end_minute,
          on_time: fan_on_time,
          off_time: fan_off_time
        },
        PUMP: {
          start_time: pump_start_hour + ":" + pump_start_minute,
          end_time: pump_end_hour + ":" + pump_end_minute,
          on_time: pump_on_time,
          off_time: pump_off_time
        },
        CAMERA: {
          interval: camera_interval  // 카메라 인터벌 추가
        }
      };

      data.append('func', 'save_env');
      data.append('env', JSON.stringify(env));

      console.log("Sending data to server:", data);

      POST(API_post, data, function (resp)
      {
        if (resp.data)
        {
          console.log(resp.data);
          get_env_data();
        }
        else
        {
          alert("no message");
        }
      });
    });

    var get_timelapse_videos = function ()
    {
      var data = new FormData();
      data.append('func', 'get_timelapse_videos');

      POST(API_post, data, function (resp)
      {
        if (resp.data)
        {
          const container = document.getElementById("timelapse_videos");
          container.innerHTML = ""; // 초기화

          resp.data.forEach(video =>
          {
            const videoLink = document.createElement("a");
            videoLink.href = "#";
            videoLink.innerText = video.name;
            videoLink.onclick = () =>
            {
              const iframe = document.getElementById("videoFrame");
              iframe.src = video.path;
            };
            videoLink.style.display = "block";
            container.appendChild(videoLink);
          });

        }
        else
          alert("no message");
      });
    }

    var get_env_data = function ()
    {
      var data = new FormData();
      data.append('func', 'get_env');

      POST(API_post, data, function (resp)
      {
        if (resp.data)
        {
          try
          {
            // resp.data에서 JSON 파싱하여 env 객체로 변환
            const env = JSON.parse(resp.data);

            // 시간을 분리하는 함수 (HH:MM 형식)
            function split_time(timeStr)
            {
              const [hour, minute] = timeStr.split(':');
              return { hour, minute };
            }

            // LED 관련 설정 값 반영
            let ledStartTime = split_time(env.LED.start_time);
            document.getElementById('led_start_hour').value = ledStartTime.hour;
            document.getElementById('led_start_minute').value = ledStartTime.minute;

            let ledEndTime = split_time(env.LED.end_time);
            document.getElementById('led_end_hour').value = ledEndTime.hour;
            document.getElementById('led_end_minute').value = ledEndTime.minute;

            document.getElementById('led_on_time').value = env.LED.on_time;
            document.getElementById('led_off_time').value = env.LED.off_time;

            // FAN 관련 설정 값 반영
            let fanStartTime = split_time(env.FAN.start_time);
            document.getElementById('fan_start_hour').value = fanStartTime.hour;
            document.getElementById('fan_start_minute').value = fanStartTime.minute;

            let fanEndTime = split_time(env.FAN.end_time);
            document.getElementById('fan_end_hour').value = fanEndTime.hour;
            document.getElementById('fan_end_minute').value = fanEndTime.minute;

            document.getElementById('fan_on_time').value = env.FAN.on_time;
            document.getElementById('fan_off_time').value = env.FAN.off_time;

            // PUMP 관련 설정 값 반영
            let pumpStartTime = split_time(env.PUMP.start_time);
            document.getElementById('pump_start_hour').value = pumpStartTime.hour;
            document.getElementById('pump_start_minute').value = pumpStartTime.minute;

            let pumpEndTime = split_time(env.PUMP.end_time);
            document.getElementById('pump_end_hour').value = pumpEndTime.hour;
            document.getElementById('pump_end_minute').value = pumpEndTime.minute;

            document.getElementById('pump_on_time').value = env.PUMP.on_time;
            document.getElementById('pump_off_time').value = env.PUMP.off_time;

            // 카메라 인터벌 반영
            document.getElementById('camera_interval').value = env.CAMERA.interval;

          } catch (e)
          {
            console.error('Error parsing JSON:', e);
          }
        } else
        {
          alert("no message");
        }
      });
    }


  </script>
</body>

</html>